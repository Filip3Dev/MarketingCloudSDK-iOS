<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>Journey Builder for Apps iOS SDK (v5.0.0) : Rich Notifications</title>
        <meta name="description" content="">

        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/syntax.css">
        <link rel="stylesheet" href="/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class=row-fluid>
                <div id=header class=span12>
                    <h4><a class=brand href="/">Journey Builder for Apps iOS SDK (v5.0.0)</a>
    
    
</h4>


                </div>
            </div>

            <div class=row-fluid>
                
                
                    <div id=navigation class=span2>
                        <ul class="nav nav-list">
    <li><a href="/">Home</a></li>
    
        
        

        
    
        
        

        
            
                <li class=nav-header>Get Started</li>
            
            <li data-order="3"><a href="/get-started/implement-sdk.html">Implement and Configure SDK</a></li>
        
            
            <li data-order="2"><a href="/get-started/create-apps-overview.html">Create MobilePush App</a></li>
        
            
            <li data-order="1"><a href="/get-started/apple.html">Provision Mobile App with Apple</a></li>
        
    
        
        

        
    
        
        

        
    
        
        

        
    
        
        

        
            
                <li class=nav-header>Push Notifications</li>
            
            <li data-order="1"><a href="/push-notifications/push-notifications.html">Push Notifications</a></li>
        
            
            <li data-order="4"><a href="/push-notifications/rich-notifications.html">Rich Notifications</a></li>
        
            
            <li data-order="3"><a href="/push-notifications/interactive-notifications.html">Interactive Notifications</a></li>
        
            
            <li data-order="2"><a href="/push-notifications/custom-sound.html">Custom Sound</a></li>
        
    
        
        

        
            
                <li class=nav-header>User Data</li>
            
            <li data-order="1"><a href="/user-data/user-data.html">User Data</a></li>
        
            
            <li data-order="2"><a href="/user-data/contact-key.html">Contact Key</a></li>
        
            
            <li data-order="3"><a href="/user-data/tags.html">Tags</a></li>
        
            
            <li data-order="4"><a href="/user-data/attributes.html">Attributes</a></li>
        
    
        
        

        
            
                <li class=nav-header>OpenDirect</li>
            
            <li data-order="4"><a href="/opendirect/opendirect.html">OpenDirect</a></li>
        
    
        
        

        
            
                <li class=nav-header>Location Services</li>
            
            <li data-order="3"><a href="/location/add-beacons.html">Beacons</a></li>
        
            
            <li data-order="1"><a href="/location/geolocation-overview.html">Overview</a></li>
        
            
            <li data-order="2"><a href="/location/geolocation.html">Background Location Updates</a></li>
        
    
        
        

        
            
                <li class=nav-header>Inbox</li>
            
            <li data-order="1"><a href="/inbox/inbox.html">Inbox</a></li>
        
            
            <li data-order="2"><a href="/inbox/cloudpage-push-overview.html">CloudPage Alert Overview</a></li>
        
    
        
        

        
            
                <li class=nav-header>Analytics</li>
            
            <li data-order="2"><a href="/analytics/personalization-collect.html">Personalization Builder and Collect API Integration</a></li>
        
            
            <li data-order="1"><a href="/analytics/analytics.html">Analytics</a></li>
        
    
        
        

        
            
                <li class=nav-header>Feature Implementation</li>
            
            <li data-order="5"><a href="/features/custom-keys.html">Custom Keys</a></li>
        
    
        
        

        
            
                <li class=nav-header>Troubleshooting</li>
            
            <li data-order="4"><a href="/trouble/sdk-migration.html">SDK Migration</a></li>
        
            
            <li data-order="3"><a href="/trouble/data-migration.html">User Data Migration</a></li>
        
            
            <li data-order="4"><a href="/trouble/business-unit-switching.html">Switch Business Units</a></li>
        
            
            <li data-order="2"><a href="/trouble/multiple-push-sdks.html">Multiple Push SDKs Troubleshooting</a></li>
        
            
            <li data-order="1"><a href="/trouble/ios-debugging.html">iOS Debugging</a></li>
        
    
        
        

        
    
        
        

        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class=divider></li> first to break up the content. -->
</ul>

                    </div>

                    <div id=content class=span10>
                        <div class=page-header>
    <h2>Send Rich Notifications</h2>
</div>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Make sure that your iOS app is built for iOS 10 or 11.</li>
  <li>Include a service extension for your app that can handle mutable content. See <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ModifyingNotifications.html">Apple’s documentation</a>.</li>
  <li>Update to version 4.9.6 or higher of the Journey Builder for Apps (JB4A) SDK, which supports iOS 10.</li>
  <li>Make sure that your app is registered for push notifications via the MarketingCloudSDK.</li>
</ul>

<p>Rich notifications include images, videos, titles and subtitles from the MobilePush app, and mutable content. Mutable content can include personalization in the title, subtitle, or body of your message. Use Xcode 9 from Apple to create a Notification Service Extension in your application project.</p>

<ol>
  <li>Click <strong>File</strong>.</li>
  <li>Click <strong>New</strong>.</li>
  <li>Click <strong>Target</strong>.</li>
  <li>Select Notification Service Extension.</li>
  <li>Name and save the new extension.</li>
</ol>

<blockquote>
  <p>Note: Notification Target must be signed by the same XCode Managed Profile as the main project.</p>
</blockquote>

<h2 id="service-extension-example-in-objective-c">Service Extension Example in Objective C</h2>

<p>This service extension checks for a “_mediaUrl” element in request.content.userInfo.  If found, the extension attempts to download the media from the URL , creates a thumbnail-size version, and then adds the attachment. The service extension also checks for a ““_mediaAlt” element in request.content.userInfo.  If found, the service extension uses the element for the body text if there are any problems downloading or creating the media attachment.</p>

<p>A service extension can timeout when it is unable to download.  In this code sample, the service extension delivers the original content with the body text changed to the value in “_mediaAlt”.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Copyright (c) 2017, salesforce.com, inc.
 * All rights reserved.
 * Licensed under the BSD 3-Clause license.
 * For full license text, see LICENSE.txt file in the repo root  or https://opensource.org/licenses/BSD-3-Clause
 */</span>

<span class="cp">#import "NotificationService.h"
#import &lt;CoreGraphics/CoreGraphics.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">NotificationService</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">contentHandler</span><span class="p">)(</span><span class="n">UNNotificationContent</span> <span class="o">*</span><span class="n">contentToDeliver</span><span class="p">);</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UNMutableNotificationContent</span> <span class="o">*</span><span class="n">modifiedNotificationContent</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">NotificationService</span>

<span class="k">-</span> <span class="p">(</span><span class="n">UNNotificationAttachment</span> <span class="o">*</span><span class="p">)</span><span class="nf">createMediaAttachment</span><span class="p">:(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">localMediaUrl</span> <span class="p">{</span>
    <span class="c1">// options: specify what cropping rectangle of the media to use for a thumbnail
</span>    <span class="c1">//          whether the thumbnail is hidden or not
</span>    <span class="n">UNNotificationAttachment</span> <span class="o">*</span><span class="n">mediaAttachment</span> <span class="o">=</span> <span class="p">[</span><span class="n">UNNotificationAttachment</span> <span class="nf">attachmentWithIdentifier</span><span class="p">:</span> <span class="s">@"attachmentIdentifier"</span>
                                                                                               <span class="nf">URL</span><span class="p">:</span> <span class="n">localMediaUrl</span>
                                                                                           <span class="nl">options:</span> <span class="p">@{</span>
                                                                                                      <span class="nl">UNNotificationAttachmentOptionsThumbnailClippingRectKey:</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">CFBridgingRelease</span><span class="p">(</span><span class="n">CGRectCreateDictionaryRepresentation</span><span class="p">(</span><span class="n">CGRectZero</span><span class="p">)),</span>
                                                                                                      <span class="nl">UNNotificationAttachmentOptionsThumbnailHiddenKey:</span> <span class="nb">@NO</span><span class="p">}</span>
                                                                                             <span class="nl">error:</span> <span class="nb">nil</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">mediaAttachment</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveNotificationRequest</span><span class="p">:(</span><span class="n">UNNotificationRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">withContentHandler</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">UNNotificationContent</span> <span class="o">*</span> <span class="n">_Nonnull</span><span class="p">))</span><span class="nv">contentHandler</span> <span class="p">{</span>

    <span class="c1">// save the completion handler we will call back later
</span>    <span class="n">self</span><span class="p">.</span><span class="n">contentHandler</span> <span class="o">=</span> <span class="n">contentHandler</span><span class="p">;</span>

    <span class="c1">// make a copy of the notification so we can change it
</span>    <span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="nf">mutableCopy</span><span class="p">];</span>

    <span class="c1">// alternative text to display if there are any issues loading the media URL
</span>    <span class="n">NSString</span> <span class="o">*</span><span class="n">mediaAltText</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">userInfo</span><span class="p">[</span><span class="s">@"_mediaAlt"</span><span class="p">];</span>

    <span class="c1">// does the payload contains a remote URL to download or a local URL?
</span>    <span class="n">NSString</span> <span class="o">*</span><span class="n">mediaUrlString</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">userInfo</span><span class="p">[</span><span class="s">@"_mediaUrl"</span><span class="p">];</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">mediaUrl</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span> <span class="n">mediaUrlString</span><span class="p">];</span>

    <span class="c1">// if we have a URL, try to download media (i.e., https://media.giphy.com/media/3oz8xJBbCpzG9byZmU/giphy.gif)
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">mediaUrl</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// create a session to handle downloading of the URL
</span>        <span class="n">NSURLSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLSession</span> <span class="nf">sessionWithConfiguration</span><span class="p">:[</span><span class="n">NSURLSessionConfiguration</span> <span class="nf">defaultSessionConfiguration</span><span class="p">]];</span>

        <span class="c1">// start a download task to handle the download of the media
</span>        <span class="n">__weak</span> <span class="n">__typeof__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
        <span class="p">[[</span><span class="n">session</span> <span class="nf">downloadTaskWithURL</span><span class="p">:</span><span class="n">mediaUrl</span> <span class="nf">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">location</span><span class="p">,</span> <span class="n">NSURLResponse</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">response</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BOOL</span> <span class="n">useAlternateText</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>

            <span class="c1">// if the download succeeded, save it locally and then make an attachment
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="p">((</span><span class="n">NSHTTPURLResponse</span><span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">).</span><span class="n">statusCode</span>  <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">NSHTTPURLResponse</span><span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">).</span><span class="n">statusCode</span> <span class="o">&lt;=</span> <span class="mi">299</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// download was successful, attempt save the media file
</span>                    <span class="n">NSURL</span> <span class="o">*</span><span class="n">localMediaUrl</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:[</span><span class="n">location</span><span class="p">.</span><span class="n">path</span> <span class="nf">stringByAppendingString</span><span class="p">:</span><span class="n">mediaUrl</span><span class="p">.</span><span class="n">lastPathComponent</span><span class="p">]];</span>

                    <span class="c1">// remove any existing file with the same name
</span>                    <span class="p">[[</span><span class="n">NSFileManager</span> <span class="nf">defaultManager</span><span class="p">]</span> <span class="nf">removeItemAtURL</span><span class="p">:</span><span class="n">localMediaUrl</span> <span class="nf">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>

                    <span class="c1">// move the downloaded file from the temporary location to a new file
</span>                    <span class="k">if</span> <span class="p">([[</span><span class="n">NSFileManager</span> <span class="nf">defaultManager</span><span class="p">]</span> <span class="nf">moveItemAtURL</span><span class="p">:</span><span class="n">location</span> <span class="nf">toURL</span><span class="p">:</span><span class="n">localMediaUrl</span> <span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">]</span> <span class="o">==</span> <span class="nb">YES</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// create an attachment with the new file
</span>                        <span class="n">UNNotificationAttachment</span> <span class="o">*</span> <span class="n">mediaAttachment</span> <span class="o">=</span> <span class="p">[</span><span class="n">weakSelf</span> <span class="nf">createMediaAttachment</span><span class="p">:</span><span class="n">localMediaUrl</span><span class="p">];</span>

                        <span class="c1">// if no problems creating the attachment, we can use it
</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">mediaAttachment</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c1">// set the media to display in the notification
</span>                            <span class="n">weakSelf</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">.</span><span class="n">attachments</span> <span class="o">=</span> <span class="p">@[</span><span class="n">mediaAttachment</span><span class="p">];</span>

                            <span class="c1">// everything is ok
</span>                            <span class="n">useAlternateText</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// if any problems creating the attachment, use the alternate text if provided
</span>            <span class="k">if</span> <span class="p">((</span><span class="n">useAlternateText</span> <span class="o">==</span> <span class="nb">YES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mediaAltText</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">weakSelf</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">mediaAltText</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// tell the OS we are done and here is the new content
</span>            <span class="n">weakSelf</span><span class="p">.</span><span class="n">contentHandler</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">);</span>
        <span class="p">}]</span> <span class="n">resume</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// see if the media URL is for a local file  (i.e., file://movie.mp4)
</span>        <span class="n">BOOL</span> <span class="n">useAlternateText</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mediaUrlString</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// attempt to create a URL to a file in local storage
</span>            <span class="n">NSURL</span> <span class="o">*</span><span class="n">localMediaUrl</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:[[</span><span class="n">NSBundle</span> <span class="nf">mainBundle</span><span class="p">]</span> <span class="nf">pathForResource</span><span class="p">:</span> <span class="n">mediaUrlString</span><span class="p">.</span><span class="n">lastPathComponent</span><span class="p">.</span><span class="n">stringByDeletingLastPathComponent</span> <span class="nf">ofType</span><span class="p">:</span><span class="n">mediaUrlString</span><span class="p">.</span><span class="n">pathExtension</span><span class="p">]];</span>

            <span class="c1">// is the URL a local file URL?
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">localMediaUrl</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="o">&amp;&amp;</span> <span class="n">localMediaUrl</span><span class="p">.</span><span class="n">isFileURL</span> <span class="o">==</span> <span class="nb">YES</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// create an attachment with the local media
</span>                <span class="n">UNNotificationAttachment</span> <span class="o">*</span> <span class="n">mediaAttachment</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">createMediaAttachment</span><span class="p">:</span><span class="n">localMediaUrl</span><span class="p">];</span>

                <span class="c1">// if no problems creating the attachment, we can use it
</span>                <span class="k">if</span> <span class="p">(</span><span class="n">mediaAttachment</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// set the media to display in the notification
</span>                    <span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">.</span><span class="n">attachments</span> <span class="o">=</span> <span class="p">@[</span><span class="n">mediaAttachment</span><span class="p">];</span>

                    <span class="c1">// everything is ok
</span>                    <span class="n">useAlternateText</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// if any problems creating the attachment, use the alternate text if provided
</span>        <span class="k">if</span> <span class="p">((</span><span class="n">useAlternateText</span> <span class="o">==</span> <span class="nb">YES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mediaAltText</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">mediaAltText</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// tell the OS we are done and here is the new content
</span>        <span class="n">contentHandler</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">serviceExtensionTimeWillExpire</span> <span class="p">{</span>
    <span class="c1">// Called just before the extension will be terminated by the system.
</span>    <span class="c1">// Use this as an opportunity to deliver your "best attempt" at modified content, otherwise the original push payload will be used.
</span>
    <span class="c1">// we took too long to download the media URL, use the alternate text if provided
</span>    <span class="n">NSString</span> <span class="o">*</span><span class="n">mediaAltText</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">.</span><span class="n">userInfo</span><span class="p">[</span><span class="s">@"_mediaAlt"</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mediaAltText</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">mediaAltText</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// tell the OS we are done and here is the new content
</span>    <span class="n">self</span><span class="p">.</span><span class="n">contentHandler</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">modifiedNotificationContent</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<h2 id="service-extension-example-in-swift">Service Extension Example in Swift</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * Copyright (c) 2017, salesforce.com, inc.
 * All rights reserved.
 * Licensed under the BSD 3-Clause license.
 * For full license text, see LICENSE.txt file in the repo root  or https://opensource.org/licenses/BSD-3-Clause
 */

import CoreGraphics
import UserNotifications

class NotificationService: UNNotificationServiceExtension {
    var contentHandler: ((_ contentToDeliver: UNNotificationContent) -&gt; Void)? = nil
    var modifiedNotificationContent: UNMutableNotificationContent?

    func createMediaAttachment(_ localMediaUrl: URL) -&gt; UNNotificationAttachment {
        // options: specify what cropping rectangle of the media to use for a thumbnail
        //          whether the thumbnail is hidden or not
        let clippingRect = CGRect.zero
        let mediaAttachment = try? UNNotificationAttachment(identifier: "attachmentIdentifier", url: localMediaUrl, options: [UNNotificationAttachmentOptionsThumbnailClippingRectKey: clippingRect.dictionaryRepresentation, UNNotificationAttachmentOptionsThumbnailHiddenKey: false])
        return mediaAttachment!
    }

    override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -&gt; Void) {

        // save the completion handler we will call back later
        self.contentHandler = contentHandler

        // make a copy of the notification so we can change it
        modifiedNotificationContent = (request.content.mutableCopy() as? UNMutableNotificationContent)

        // does the payload contains a remote URL to download or a local URL?
        if let mediaUrlString = request.content.userInfo["_mediaUrl"] as? String {
            // see if the media URL is for a local file  (i.e., file://movie.mp4)
            guard let mediaUrl = URL(string: mediaUrlString) else {
                // attempt to create a URL to a file in local storage
                var useAlternateText: Bool = true
                if mediaUrlString.isEmpty == false {
                    let mediaUrlFilename:NSString = mediaUrlString as NSString
                    let fileName = (mediaUrlFilename.lastPathComponent as NSString).deletingPathExtension
                    let fileExtension = (mediaUrlFilename.lastPathComponent as NSString).pathExtension

                    // is it in the bundle?
                    if let localMediaUrlPath = Bundle.main.path(forResource: fileName, ofType: fileExtension) {
                        // is the URL a local file URL?
                        let localMediaUrl = URL.init(fileURLWithPath: localMediaUrlPath)
                        if localMediaUrl.isFileURL == true {
                            // create an attachment with the local media
                            let mediaAttachment: UNNotificationAttachment? = createMediaAttachment(localMediaUrl)

                            // if no problems creating the attachment, we can use it
                            if mediaAttachment != nil {
                                // set the media to display in the notification
                                modifiedNotificationContent?.attachments = [mediaAttachment!]

                                // everything is ok
                                useAlternateText = false
                            }
                        }
                    }
                }

                // if any problems creating the attachment, use the alternate text if provided
                if (useAlternateText == true) {
                    if let mediaAltText = request.content.userInfo["_mediaAlt"] as? String {
                        if mediaAltText.isEmpty == false {
                            modifiedNotificationContent?.body = mediaAltText
                        }
                    }
                }

                // tell the OS we are done and here is the new content
                contentHandler(modifiedNotificationContent!)
                return
            }

            // if we have a URL, try to download media (i.e., https://media.giphy.com/media/3oz8xJBbCpzG9byZmU/giphy.gif)
            if mediaUrl.isFileURL == false {
                // create a session to handle downloading of the URL
                let session = URLSession(configuration: URLSessionConfiguration.default)

                // start a download task to handle the download of the media
                weak var weakSelf: NotificationService? = self
                session.downloadTask(with: mediaUrl, completionHandler: {(_ location: URL?, _ response: URLResponse?, _ error: Error?) -&gt; Void in
                    var useAlternateText: Bool = true
                    // if the download succeeded, save it locally and then make an attachment
                    if error == nil {
                        let downloadResponse = response as! HTTPURLResponse
                        if (downloadResponse.statusCode &gt;= 200 &amp;&amp; downloadResponse.statusCode &lt;= 299) {
                            // download was successful, attempt save the media file
                            let localMediaUrl = URL.init(fileURLWithPath: location!.path + mediaUrl.lastPathComponent)

                            // remove any existing file with the same name
                            try? FileManager.default.removeItem(at: localMediaUrl)

                            // move the downloaded file from the temporary location to a new file
                            if ((try? FileManager.default.moveItem(at: location!, to: localMediaUrl)) != nil) {
                                // create an attachment with the new file
                                let mediaAttachment: UNNotificationAttachment? = weakSelf?.createMediaAttachment(localMediaUrl)

                                // if no problems creating the attachment, we can use it
                                if mediaAttachment != nil {
                                    // set the media to display in the notification
                                    weakSelf?.modifiedNotificationContent?.attachments = [mediaAttachment!]

                                    // everything is ok
                                    useAlternateText = false
                                }
                            }
                        }
                    }

                    // if any problems creating the attachment, use the alternate text if provided
                    // alternative text to display if there are any issues loading the media URL
                    if (useAlternateText == true) {
                        if let mediaAltText = request.content.userInfo["_mediaAlt"] as? String {
                            if mediaAltText.isEmpty == false {
                                weakSelf?.modifiedNotificationContent?.body = mediaAltText
                            }
                        }
                    }

                    // tell the OS we are done and here is the new content
                    weakSelf?.contentHandler!((weakSelf?.modifiedNotificationContent)!)
                }).resume()
            }
        }
        else {
            // no media URL found in the payload, just pass on the orginal payload
            contentHandler(request.content)
            return
        }
    }

    override func serviceExtensionTimeWillExpire() {
        // Called just before the extension will be terminated by the system.
        // Use this as an opportunity to deliver your "best attempt" at modified content, otherwise the original push payload will be used.
        // we took too long to download the media URL, use the alternate text if provided

        if let mediaAltText = modifiedNotificationContent?.userInfo["_mediaAlt"] as? String {
            // alternative text to display if there are any issues loading the media URL
            if mediaAltText.isEmpty == false {
                modifiedNotificationContent?.body = mediaAltText
            }
        }

        // tell the OS we are done and here is the new content
        contentHandler!(modifiedNotificationContent!)
    }
}
</code></pre></div></div>


                    </div>
                
            </div>

            

            <div class=row-fluid>
                <div id=footer class=span12>
                    Documentation for <a href="https://github.com/ExactTarget/JB4A-SDK-iOS" target="_blank">Journey Builder for Apps iOS SDK (v5.0.0)</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>

        
            <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82902574-4', 'auto');
  ga('send', 'pageview');
</script>

        
    </body>
</html>
